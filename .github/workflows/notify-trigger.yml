name: notify-trigger

on:
  schedule:
    - cron:  '00 11 * * *'

  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Check for 'tock-tbf' updates
        run: |
          TARGET_FILE="tock-tbf/src"
          
          RESPONSE=$(curl -s "https://api.github.com/repos/ioqnq/KevinCookieCompany.com/commits?path=$TARGET_FILE&sha=main")
          
          COMMIT_SHA=$(echo "$RESPONSE" | jq -r ".[0].sha")
          
          echo "Commit sha: $COMMIT_SHA"

          SHA_RESPONSE=$(curl -s -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/ioqnq/KevinCookiedownstream/contents/.lastcommsha)

          STORED_SHA=$(echo "$SHA_RESPONSE" | jq -r '.content' | base64 -d | tr -d '\n')
          echo "Last stored SHA: $STORED_SHA"

          if [ "$COMMIT_SHA" == "$STORED_SHA" ]; then
            echo "Up to date."
            exit 0
          else
            echo "Different - must update
            
            CURR_COMM = $(echo "$RESPONSE" | jq -r ".[0].sha")
            i = 0
            COMM_SHAS = ()
            
            while [ "$CURR_COMM" != "$STORED_SHA" ]
            do
              CURR_COMM_SHA = $(echo "$RESPONSE" | jq -r ".[i].sha")
              COMM_SHAS += ("$CURR_COM_SHA")
              i=$(expr $i + 1)
            done

            for sha in ${!COMM_SHAS[@]}; do
              echo "sha $sha is ${COMM_SHAS[$i]}"
            done
            
            exit 1
          fi

          

